<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kavárna – Registrace</title>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,400;0,500;0,600;1,400&family=DM+Sans:wght@400;500;600&display=swap" rel="stylesheet">

    <!-- Stylesheets -->
    <link rel="stylesheet" href="/static/css/variables.css">
    <link rel="stylesheet" href="/static/css/base.css">
    <link rel="stylesheet" href="/static/css/components.css">
    <link rel="stylesheet" href="/static/css/animations.css">
    <link rel="stylesheet" href="/static/css/login.css">

    <style>
        /* Additional styles for registration page */
        .form-error {
            display: none;
            padding: 12px 16px;
            background: rgba(184, 92, 92, 0.1);
            border: 1px solid var(--error);
            border-radius: var(--radius-lg);
            color: var(--error);
            font-size: var(--text-base);
            margin-bottom: 20px;
            animation: fadeInUp 0.3s ease;
        }

        .form-error.visible {
            display: block;
        }

        .btn-loading {
            position: relative;
            pointer-events: none;
        }

        .btn-loading .btn-text {
            opacity: 0;
        }

        .btn-loading .spinner {
            display: block;
        }

        .spinner {
            display: none;
            position: absolute;
            width: 20px;
            height: 20px;
            border: 2px solid var(--espresso);
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        .input-error {
            border-color: var(--error) !important;
        }

        .input-error:focus {
            box-shadow: 0 0 0 3px rgba(184, 92, 92, 0.15) !important;
        }

        .field-error {
            display: none;
            font-size: 0.75rem;
            color: var(--error);
            margin-top: 6px;
        }

        .field-error.visible {
            display: block;
        }

        .password-requirements {
            font-size: 0.75rem;
            color: var(--espresso-light);
            margin-top: 6px;
            line-height: 1.4;
        }

        .password-requirements ul {
            margin: 4px 0 0 16px;
            padding: 0;
        }

        .password-requirements li {
            margin-bottom: 2px;
        }

        .password-requirements li.valid {
            color: var(--success);
        }

        .password-requirements li.valid::marker {
            content: "✓ ";
        }
    </style>
</head>
<body class="login-page">
    <div class="login-container">
        <div class="login-card">
            <!-- Logo -->
            <div class="logo">
                <div class="logo-icon" aria-hidden="true">☕</div>
                <h1 class="logo-text">Kavárna<span>.</span></h1>
                <p class="logo-subtitle">Vytvořte si nový účet</p>
            </div>

            <!-- Error message -->
            <div class="form-error" id="formError" role="alert"></div>

            <!-- Form -->
            <form id="registerForm" novalidate>
                <div class="form-group">
                    <label class="form-label" for="displayName">Jméno (volitelné)</label>
                    <div class="input-wrapper">
                        <input
                            type="text"
                            id="displayName"
                            class="form-input"
                            placeholder="Jan Novák"
                            autocomplete="name"
                        >
                        <svg class="input-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" aria-hidden="true">
                            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                            <circle cx="12" cy="7" r="4"/>
                        </svg>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label" for="email">E-mail</label>
                    <div class="input-wrapper">
                        <input
                            type="email"
                            id="email"
                            class="form-input"
                            placeholder="vas@email.cz"
                            autocomplete="email"
                            required
                        >
                        <svg class="input-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" aria-hidden="true">
                            <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
                            <path d="m22 6-10 7L2 6"/>
                        </svg>
                    </div>
                    <p class="field-error" id="emailError"></p>
                </div>

                <div class="form-group">
                    <label class="form-label" for="password">Heslo</label>
                    <div class="input-wrapper">
                        <input
                            type="password"
                            id="password"
                            class="form-input"
                            placeholder="••••••••"
                            autocomplete="new-password"
                            required
                        >
                        <svg class="input-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" aria-hidden="true">
                            <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/>
                            <path d="M7 11V7a5 5 0 0 1 10 0v4"/>
                        </svg>
                        <button
                            type="button"
                            class="password-toggle"
                            onclick="togglePassword('password')"
                            aria-label="Zobrazit/skrýt heslo"
                        >
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" id="password-eye-icon" aria-hidden="true">
                                <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                                <circle cx="12" cy="12" r="3"/>
                            </svg>
                        </button>
                    </div>
                    <p class="field-error" id="passwordError"></p>
                    <div class="password-requirements" id="passwordRequirements">
                        <ul>
                            <li id="req-length">Alespoň 8 znaků</li>
                            <li id="req-uppercase">Alespoň 1 velké písmeno</li>
                            <li id="req-number">Alespoň 1 číslo</li>
                        </ul>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label" for="passwordConfirm">Potvrdit heslo</label>
                    <div class="input-wrapper">
                        <input
                            type="password"
                            id="passwordConfirm"
                            class="form-input"
                            placeholder="••••••••"
                            autocomplete="new-password"
                            required
                        >
                        <svg class="input-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" aria-hidden="true">
                            <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/>
                            <path d="M7 11V7a5 5 0 0 1 10 0v4"/>
                        </svg>
                        <button
                            type="button"
                            class="password-toggle"
                            onclick="togglePassword('passwordConfirm')"
                            aria-label="Zobrazit/skrýt heslo"
                        >
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" id="passwordConfirm-eye-icon" aria-hidden="true">
                                <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                                <circle cx="12" cy="12" r="3"/>
                            </svg>
                        </button>
                    </div>
                    <p class="field-error" id="passwordConfirmError"></p>
                </div>

                <button type="submit" class="btn btn-primary" id="submitBtn">
                    <span class="btn-text">Zaregistrovat se</span>
                    <span class="spinner"></span>
                    <svg class="btn-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                        <path d="M5 12h14M12 5l7 7-7 7"/>
                    </svg>
                </button>
            </form>

            <!-- Footer -->
            <div class="login-footer">
                <p>Už máte účet? <a href="/login">Přihlaste se</a></p>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script type="module">
        import { api, ApiError } from '/static/js/api.js';
        import AuthStore from '/static/js/auth.js';
        import Config from '/static/js/config.js';

        // DOM elements
        const form = document.getElementById('registerForm');
        const displayNameInput = document.getElementById('displayName');
        const emailInput = document.getElementById('email');
        const passwordInput = document.getElementById('password');
        const passwordConfirmInput = document.getElementById('passwordConfirm');
        const submitBtn = document.getElementById('submitBtn');
        const formError = document.getElementById('formError');
        const emailError = document.getElementById('emailError');
        const passwordError = document.getElementById('passwordError');
        const passwordConfirmError = document.getElementById('passwordConfirmError');

        // Password requirement elements
        const reqLength = document.getElementById('req-length');
        const reqUppercase = document.getElementById('req-uppercase');
        const reqNumber = document.getElementById('req-number');

        // Check if already authenticated
        if (AuthStore.isAuthenticated()) {
            window.location.href = Config.ROUTES.DASHBOARD;
        }

        // Toggle password visibility
        window.togglePassword = function(fieldId) {
            const input = document.getElementById(fieldId);
            const icon = document.getElementById(`${fieldId}-eye-icon`);

            if (input.type === 'password') {
                input.type = 'text';
                icon.innerHTML = `
                    <path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"/>
                    <line x1="1" y1="1" x2="23" y2="23"/>
                `;
            } else {
                input.type = 'password';
                icon.innerHTML = `
                    <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                    <circle cx="12" cy="12" r="3"/>
                `;
            }
        };

        // Clear field errors on input
        function clearFieldError(input, errorEl) {
            input.classList.remove('input-error');
            errorEl.classList.remove('visible');
            formError.classList.remove('visible');
        }

        emailInput.addEventListener('input', () => clearFieldError(emailInput, emailError));
        passwordInput.addEventListener('input', () => {
            clearFieldError(passwordInput, passwordError);
            validatePasswordRequirements(passwordInput.value);
        });
        passwordConfirmInput.addEventListener('input', () => clearFieldError(passwordConfirmInput, passwordConfirmError));

        // Validate password requirements in real-time
        function validatePasswordRequirements(password) {
            const hasLength = password.length >= 8;
            const hasUppercase = /[A-Z]/.test(password);
            const hasNumber = /[0-9]/.test(password);

            reqLength.classList.toggle('valid', hasLength);
            reqUppercase.classList.toggle('valid', hasUppercase);
            reqNumber.classList.toggle('valid', hasNumber);

            return hasLength && hasUppercase && hasNumber;
        }

        // Validate email
        function validateEmail(email) {
            const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return re.test(email);
        }

        // Show error message
        function showError(message) {
            formError.textContent = message;
            formError.classList.add('visible');
        }

        // Show field error
        function showFieldError(input, errorEl, message) {
            input.classList.add('input-error');
            errorEl.textContent = message;
            errorEl.classList.add('visible');
        }

        // Set loading state
        function setLoading(loading) {
            if (loading) {
                submitBtn.classList.add('btn-loading');
                submitBtn.disabled = true;
            } else {
                submitBtn.classList.remove('btn-loading');
                submitBtn.disabled = false;
            }
        }

        // Form submission
        form.addEventListener('submit', async (e) => {
            e.preventDefault();

            // Clear previous errors
            formError.classList.remove('visible');
            emailInput.classList.remove('input-error');
            passwordInput.classList.remove('input-error');
            passwordConfirmInput.classList.remove('input-error');
            emailError.classList.remove('visible');
            passwordError.classList.remove('visible');
            passwordConfirmError.classList.remove('visible');

            const displayName = displayNameInput.value.trim();
            const email = emailInput.value.trim();
            const password = passwordInput.value;
            const passwordConfirm = passwordConfirmInput.value;

            // Validation
            let hasErrors = false;

            if (!email) {
                showFieldError(emailInput, emailError, 'Zadejte e-mail');
                hasErrors = true;
            } else if (!validateEmail(email)) {
                showFieldError(emailInput, emailError, 'Zadejte platný e-mail');
                hasErrors = true;
            }

            if (!password) {
                showFieldError(passwordInput, passwordError, 'Zadejte heslo');
                hasErrors = true;
            } else if (password.length < 8) {
                showFieldError(passwordInput, passwordError, 'Heslo musí mít alespoň 8 znaků');
                hasErrors = true;
            }

            if (!passwordConfirm) {
                showFieldError(passwordConfirmInput, passwordConfirmError, 'Potvrďte heslo');
                hasErrors = true;
            } else if (password !== passwordConfirm) {
                showFieldError(passwordConfirmInput, passwordConfirmError, 'Hesla se neshodují');
                hasErrors = true;
            }

            if (hasErrors) return;

            // Submit registration
            setLoading(true);

            try {
                const userData = {
                    email,
                    password,
                    password_confirm: passwordConfirm,
                };

                if (displayName) {
                    userData.display_name = displayName;
                }

                await api.auth.register(userData);

                // Redirect to dashboard
                window.location.href = Config.ROUTES.DASHBOARD;
            } catch (error) {
                setLoading(false);

                if (error instanceof ApiError) {
                    // Handle specific error cases
                    if (error.data) {
                        // Field-specific errors from the API
                        if (error.data.email) {
                            showFieldError(emailInput, emailError, 'Tento e-mail je již registrován');
                        } else if (error.data.password) {
                            const pwdErrors = Array.isArray(error.data.password)
                                ? error.data.password.join(' ')
                                : error.data.password;
                            showFieldError(passwordInput, passwordError, pwdErrors);
                        } else if (error.data.password_confirm) {
                            showFieldError(passwordConfirmInput, passwordConfirmError, 'Hesla se neshodují');
                        } else if (error.data.error) {
                            showError(error.data.error);
                        } else {
                            showError('Chyba při registraci. Zkontrolujte zadané údaje.');
                        }
                    } else {
                        switch (error.status) {
                            case 0:
                                showError('Nepodařilo se připojit k serveru');
                                break;
                            default:
                                showError(error.message || 'Nastala chyba při registraci');
                        }
                    }
                } else {
                    showError('Nastala neočekávaná chyba');
                    console.error('Registration error:', error);
                }
            }
        });
    </script>
</body>
</html>
