<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#2C1810">
    <title>Kavarna - Dashboard</title>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;500;600&family=DM+Sans:wght@400;500;600&display=swap" rel="stylesheet">

    <!-- Stylesheets -->
    <link rel="stylesheet" href="/static/css/variables.css">
    <link rel="stylesheet" href="/static/css/base.css">
    <link rel="stylesheet" href="/static/css/components.css">
    <link rel="stylesheet" href="/static/css/animations.css">
    <link rel="stylesheet" href="/static/css/dashboard.css">

    <style>
        /* Loading skeleton */
        .skeleton {
            background: linear-gradient(90deg, var(--latte) 25%, var(--milk-foam) 50%, var(--latte) 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
            border-radius: var(--radius-md);
        }

        @keyframes shimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        .skeleton-text {
            height: 1em;
            width: 100px;
            display: inline-block;
        }

        .skeleton-text.short { width: 60px; }
        .skeleton-text.long { width: 150px; }

        /* User menu dropdown */
        .user-menu { position: relative; }

        .user-dropdown {
            position: absolute;
            top: calc(100% + 8px);
            right: 0;
            background: var(--porcelain);
            border: 1px solid var(--latte);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
            min-width: 200px;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all var(--transition-base);
            z-index: var(--z-dropdown);
        }

        .user-dropdown.open {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .user-dropdown-header {
            padding: 16px;
            border-bottom: 1px solid var(--latte);
        }

        .user-dropdown-name {
            font-weight: 500;
            color: var(--espresso);
        }

        .user-dropdown-email {
            font-size: var(--text-sm);
            color: var(--steam);
            margin-top: 2px;
        }

        .user-dropdown-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            color: var(--espresso);
            text-decoration: none;
            transition: background var(--transition-base);
            cursor: pointer;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
            font-size: var(--text-base);
        }

        .user-dropdown-item:hover { background: var(--milk-foam); }
        .user-dropdown-item.danger { color: var(--error); }
        .user-dropdown-item svg { width: 18px; height: 18px; color: var(--steam); }
        .user-dropdown-item.danger svg { color: var(--error); }
        .user-dropdown-divider { height: 1px; background: var(--latte); margin: 4px 0; }

        /* Empty state */
        .empty-state {
            text-align: center;
            padding: 24px 16px;
            color: var(--steam);
        }

        /* Groups Grid */
        .groups-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }

        .group-card {
            display: flex;
            flex-direction: column;
            gap: 10px;
            padding: 16px;
            background: var(--porcelain);
            border: 1px solid var(--latte);
            border-radius: var(--radius-xl);
            cursor: pointer;
            transition: all var(--transition-base);
            text-decoration: none;
            color: inherit;
        }

        .group-card:hover {
            border-color: var(--crema-light);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .group-card-icon {
            width: 44px;
            height: 44px;
            background: linear-gradient(135deg, var(--espresso), var(--espresso-light));
            border-radius: var(--radius-lg);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
        }

        .group-card-info h4 {
            font-family: var(--font-display);
            font-size: 1rem;
            font-weight: 500;
            margin-bottom: 2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .group-card-info p {
            font-size: 0.75rem;
            color: var(--steam);
        }

        /* Add group card */
        .group-card-add {
            border-style: dashed;
            border-color: var(--caramel);
            background: linear-gradient(135deg, rgba(164, 116, 73, 0.05), rgba(164, 116, 73, 0.02));
        }

        .group-card-add:hover {
            border-color: var(--caramel);
            background: linear-gradient(135deg, rgba(164, 116, 73, 0.1), rgba(164, 116, 73, 0.05));
        }

        .group-card-add .group-card-icon {
            background: var(--caramel);
            color: var(--porcelain);
            font-size: 1.5rem;
            font-weight: 300;
        }

        .group-card-add .group-card-info h4 {
            color: var(--caramel);
        }

        .group-card-skeleton {
            height: 100px;
            border-radius: var(--radius-xl);
        }
    </style>
</head>
<body class="dashboard">
    <div class="app">
        <!-- Header -->
        <header class="header">
            <div class="header-top">
                <div class="greeting">
                    <p class="greeting-text" id="greetingText">Dobry den</p>
                    <h1 class="greeting-name" id="userName">
                        <span class="skeleton skeleton-text long"></span>
                    </h1>
                </div>
                <div class="header-actions">
                    <div class="user-menu">
                        <div class="avatar" role="button" aria-label="Uzivatelske menu" id="userAvatar" tabindex="0">?</div>
                        <div class="user-dropdown" id="userDropdown">
                            <div class="user-dropdown-header">
                                <div class="user-dropdown-name" id="dropdownName">-</div>
                                <div class="user-dropdown-email" id="dropdownEmail">-</div>
                            </div>
                            <a href="/profile/" class="user-dropdown-item">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                    <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                                    <circle cx="12" cy="7" r="4"/>
                                </svg>
                                Muj profil
                            </a>
                            <a href="/profile/" class="user-dropdown-item">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                    <circle cx="12" cy="12" r="3"/>
                                    <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/>
                                </svg>
                                Nastaveni
                            </a>
                            <div class="user-dropdown-divider"></div>
                            <button class="user-dropdown-item danger" id="logoutBtn">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                    <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
                                    <polyline points="16 17 21 12 16 7"/>
                                    <line x1="21" y1="12" x2="9" y2="12"/>
                                </svg>
                                Odhlasit se
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Quick Stats -->
        <div class="quick-stats">
            <div class="quick-stat">
                <div class="quick-stat-value" id="statReviews">-</div>
                <div class="quick-stat-label">Hodnoceni</div>
            </div>
            <div class="quick-stat">
                <div class="quick-stat-value" id="statLibrary">-</div>
                <div class="quick-stat-label">V knihovne</div>
            </div>
            <div class="quick-stat">
                <div class="quick-stat-value" id="statGroups">-</div>
                <div class="quick-stat-label">Skupiny</div>
            </div>
        </div>

        <!-- Main Navigation Cards -->
        <section class="section">
            <div class="nav-cards">
                <a href="/groups/list/" class="nav-card animate-fade-in-up delay-1">
                    <div class="nav-card-icon groups">üë•</div>
                    <div class="nav-card-content">
                        <h3>Skupiny</h3>
                        <p id="cardGroupsCount">Nacitam...</p>
                        <span class="nav-card-badge" id="cardGroupsMembers"></span>
                    </div>
                </a>

                <a href="/library/" class="nav-card animate-fade-in-up delay-2">
                    <div class="nav-card-icon library">üìö</div>
                    <div class="nav-card-content">
                        <h3>Moje knihovna</h3>
                        <p id="cardLibraryCount">Nacitam...</p>
                        <span class="nav-card-badge" id="cardLibraryBadge"></span>
                    </div>
                </a>

                <a href="/beans/" class="nav-card animate-fade-in-up delay-3">
                    <div class="nav-card-icon discover">üîç</div>
                    <div class="nav-card-content">
                        <h3>Objevovat</h3>
                        <p>Katalog kav</p>
                        <span class="nav-card-badge" id="cardBeansCount">-</span>
                    </div>
                </a>

                <a href="/purchases/" class="nav-card animate-fade-in-up delay-4">
                    <div class="nav-card-icon purchases">üí∞</div>
                    <div class="nav-card-content">
                        <h3>Nakupy</h3>
                        <p>Platby & dluhy</p>
                        <span class="nav-card-badge" id="cardDebtBadge">-</span>
                    </div>
                </a>
            </div>
        </section>

        <!-- My Groups -->
        <section class="section">
            <div class="section-header">
                <h2 class="section-title">Moje skupiny</h2>
                <a href="/groups/list/" class="section-link" id="showAllGroups">
                    Vsechny
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M9 18l6-6-6-6"/>
                    </svg>
                </a>
            </div>
            <div class="groups-grid" id="groupsList">
                <div class="skeleton group-card-skeleton"></div>
                <div class="skeleton group-card-skeleton"></div>
                <div class="skeleton group-card-skeleton"></div>
                <div class="skeleton group-card-skeleton"></div>
            </div>
        </section>

        <!-- Outstanding Payments -->
        <section class="section" id="paymentsSection" style="display: none;">
            <div class="section-header">
                <h2 class="section-title">Nezaplacene platby</h2>
            </div>
            <div id="paymentsList"></div>
        </section>
    </div>

    <!-- Add Bean Modal -->
    <div class="modal-overlay" id="addBeanModal">
        <div class="modal">
            <h3 class="modal-title">Pridat kavu do katalogu</h3>
            <form id="addBeanForm">
                <!-- Search existing bean section -->
                <div id="searchBeanSection">
                    <div class="form-group">
                        <label class="form-label">Vyhledat existujici kavu</label>
                        <div class="search-wrapper">
                            <input type="text" class="form-input" id="beanSearchInput" placeholder="Nazev kavy..." autocomplete="off">
                            <div class="search-results" id="beanSearchResults"></div>
                        </div>
                        <input type="hidden" id="selectedBeanId">
                        <div class="selected-item" id="selectedBeanDisplay" style="display: none;">
                            <div class="selected-item-icon">‚òï</div>
                            <div class="selected-item-info">
                                <div class="selected-item-name" id="selectedBeanName"></div>
                                <div class="selected-item-meta" id="selectedBeanMeta"></div>
                            </div>
                            <button type="button" class="selected-item-remove" id="removeBeanBtn">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M18 6L6 18M6 6l12 12"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                    <div style="text-align: center; margin: 16px 0;">
                        <span style="color: var(--steam); font-size: 0.875rem;">Kava neni v katalogu?</span>
                        <button type="button" id="showCreateBeanBtn" style="background: none; border: none; color: #A47449; font-weight: 500; cursor: pointer; font-size: 0.875rem; text-decoration: underline;">Vytvorit novou</button>
                    </div>
                </div>

                <!-- Create new bean section (hidden by default) -->
                <div id="createBeanSection" style="display: none;">
                    <div style="text-align: center; margin-bottom: 16px;">
                        <button type="button" id="backToSearchBtn" style="background: none; border: none; color: var(--steam); cursor: pointer; font-size: 0.875rem;">
                            ‚Üê Zpet na vyhledavani
                        </button>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Nazev kavy *</label>
                        <input type="text" class="form-input" id="newBeanName" placeholder="Napr. Ethiopia Yirgacheffe">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Prazirna *</label>
                        <input type="text" class="form-input" id="newBeanRoastery" placeholder="Napr. Doubleshot">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Zeme puvodu <span class="optional">(volitelne)</span></label>
                        <input type="text" class="form-input" id="newBeanOrigin" placeholder="Napr. Etiopie">
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Profil prazeni</label>
                            <select class="form-select" id="newBeanRoast">
                                <option value="medium">Stredni</option>
                                <option value="light">Svetly</option>
                                <option value="medium_light">Stredne svetly</option>
                                <option value="medium_dark">Stredne tmavy</option>
                                <option value="dark">Tmavy</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Zpracovani</label>
                            <select class="form-select" id="newBeanProcessing">
                                <option value="washed">Prane (Washed)</option>
                                <option value="natural">Natural</option>
                                <option value="honey">Honey</option>
                                <option value="anaerobic">Anaerobni</option>
                                <option value="other">Jine</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="form-error" id="addBeanError"></div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" id="cancelAddBeanBtn">Zrusit</button>
                    <button type="submit" class="btn btn-primary" id="submitAddBeanBtn" disabled>
                        <span class="btn-text">Pridat</span>
                        <span class="spinner"></span>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- FAB Overlay -->
    <div class="fab-overlay" id="fabOverlay"></div>

    <!-- FAB Menu -->
    <div class="fab-menu" id="fabMenu">
        <button type="button" class="fab-menu-item" id="fabAddBean"><span>‚òï</span><span>Pridat kavu</span></button>
        <button type="button" class="fab-menu-item" id="fabAddReview"><span>‚≠ê</span><span>Nove hodnoceni</span></button>
        <a href="/purchases/create/" class="fab-menu-item" id="fabAddPurchase"><span>üõí</span><span>Zaznamenat nakup</span></a>
    </div>

    <!-- Add Review Modal -->
    <div class="modal-overlay" id="addReviewModal">
        <div class="modal">
            <h3 class="modal-title">Vyberte kavu k hodnoceni</h3>

            <!-- Search existing bean section -->
            <div id="reviewSearchBeanSection">
                <div class="form-group">
                    <label class="form-label">Vyhledat kavu</label>
                    <div class="search-wrapper">
                        <input type="text" class="form-input" id="reviewBeanSearchInput" placeholder="Nazev kavy..." autocomplete="off">
                        <div class="search-results" id="reviewBeanSearchResults"></div>
                    </div>
                    <input type="hidden" id="reviewSelectedBeanId">
                    <div class="selected-item" id="reviewSelectedBeanDisplay" style="display: none;">
                        <div class="selected-item-icon">‚òï</div>
                        <div class="selected-item-info">
                            <div class="selected-item-name" id="reviewSelectedBeanName"></div>
                            <div class="selected-item-meta" id="reviewSelectedBeanMeta"></div>
                        </div>
                        <button type="button" class="selected-item-remove" id="reviewRemoveBeanBtn">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M18 6L6 18M6 6l12 12"/>
                            </svg>
                        </button>
                    </div>
                </div>
                <div style="text-align: center; margin: 16px 0;">
                    <span style="color: var(--steam); font-size: 0.875rem;">Kava neni v katalogu?</span>
                    <button type="button" id="reviewShowCreateBeanBtn" style="background: none; border: none; color: #A47449; font-weight: 500; cursor: pointer; font-size: 0.875rem; text-decoration: underline;">Pridat novou</button>
                </div>
            </div>

            <!-- Create new bean section (hidden by default) -->
            <div id="reviewCreateBeanSection" style="display: none;">
                <div style="text-align: center; margin-bottom: 16px;">
                    <button type="button" id="reviewBackToSearchBtn" style="background: none; border: none; color: var(--steam); cursor: pointer; font-size: 0.875rem;">
                        ‚Üê Zpet na vyhledavani
                    </button>
                </div>
                <div class="form-group">
                    <label class="form-label">Nazev kavy *</label>
                    <input type="text" class="form-input" id="reviewNewBeanName" placeholder="Napr. Ethiopia Yirgacheffe">
                </div>
                <div class="form-group">
                    <label class="form-label">Prazirna *</label>
                    <input type="text" class="form-input" id="reviewNewBeanRoastery" placeholder="Napr. Doubleshot">
                </div>
                <div class="form-group">
                    <label class="form-label">Zeme puvodu <span class="optional">(volitelne)</span></label>
                    <input type="text" class="form-input" id="reviewNewBeanOrigin" placeholder="Napr. Etiopie">
                </div>
            </div>

            <div class="form-error" id="addReviewError"></div>
            <div class="modal-actions">
                <button type="button" class="btn btn-secondary" id="cancelAddReviewBtn">Zrusit</button>
                <button type="button" class="btn btn-primary" id="continueToReviewBtn" disabled>
                    <span class="btn-text">Pokracovat</span>
                    <span class="spinner"></span>
                </button>
            </div>
        </div>
    </div>

    <!-- Bottom Navigation -->
    <nav class="bottom-nav" aria-label="Hlavni navigace">
        <div class="nav-items">
            <a class="nav-item active" href="/dashboard" aria-current="page">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
                    <path d="M9 22V12h6v10"/>
                </svg>
                <span>Domu</span>
            </a>
            <a class="nav-item" href="/beans/">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <circle cx="11" cy="11" r="8"/>
                    <path d="m21 21-4.35-4.35"/>
                </svg>
                <span>Hledat</span>
            </a>

            <button class="fab" id="fabBtn" aria-label="Rychle akce" aria-expanded="false">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 5v14M5 12h14"/>
                </svg>
            </button>

            <a class="nav-item" href="/groups/list/">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                    <circle cx="9" cy="7" r="4"/>
                    <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
                    <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                </svg>
                <span>Skupiny</span>
            </a>
            <a class="nav-item" href="/profile/">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                    <circle cx="12" cy="7" r="4"/>
                </svg>
                <span>Profil</span>
            </a>
        </div>
    </nav>

    <!-- Scripts -->
    <script type="module">
        import { api, ApiError } from '/static/js/api.js';
        import AuthStore from '/static/js/auth.js';
        import Config from '/static/js/config.js';

        // Check authentication
        if (!AuthStore.isAuthenticated()) {
            window.location.href = Config.ROUTES.LOGIN;
        }

        // DOM Elements
        const userNameEl = document.getElementById('userName');
        const userAvatarEl = document.getElementById('userAvatar');
        const userDropdown = document.getElementById('userDropdown');
        const dropdownNameEl = document.getElementById('dropdownName');
        const dropdownEmailEl = document.getElementById('dropdownEmail');
        const greetingTextEl = document.getElementById('greetingText');
        const logoutBtn = document.getElementById('logoutBtn');
        const fabBtn = document.getElementById('fabBtn');
        const fabMenu = document.getElementById('fabMenu');
        const fabOverlay = document.getElementById('fabOverlay');

        // Update greeting based on time
        function updateGreeting() {
            const hour = new Date().getHours();
            if (hour < 12) {
                greetingTextEl.textContent = 'Dobre rano';
            } else if (hour < 18) {
                greetingTextEl.textContent = 'Dobre odpoledne';
            } else {
                greetingTextEl.textContent = 'Dobry vecer';
            }
        }

        // Load user data from storage
        function loadUserData() {
            const user = AuthStore.getUser();
            const displayName = AuthStore.getDisplayName();
            const initials = AuthStore.getUserInitials();

            userNameEl.textContent = displayName;
            userAvatarEl.textContent = initials;

            if (user) {
                dropdownNameEl.textContent = user.display_name || displayName;
                dropdownEmailEl.textContent = user.email || '';
            }
        }

        // Escape HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text || '';
            return div.innerHTML;
        }

        // Format currency
        function formatCZK(amount) {
            return new Intl.NumberFormat('cs-CZ', {
                style: 'currency',
                currency: 'CZK',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(amount);
        }

        // Render dashboard data (all from single API call)
        function renderDashboard(data) {
            // Quick stats
            document.getElementById('statReviews').textContent = data.stats.reviews_count;
            document.getElementById('statLibrary').textContent = data.stats.library_count;
            document.getElementById('statGroups').textContent = data.stats.groups_count;

            // Groups card
            const groupsCount = data.stats.groups_count;
            document.getElementById('cardGroupsCount').textContent = groupsCount === 0
                ? 'Zadne skupiny'
                : `${groupsCount} ${groupsCount === 1 ? 'skupina' : groupsCount < 5 ? 'skupiny' : 'skupin'}`;

            const cardGroupsMembers = document.getElementById('cardGroupsMembers');
            if (data.groups.total_members > 0) {
                cardGroupsMembers.textContent = `${data.groups.total_members} clenu celkem`;
            } else {
                cardGroupsMembers.textContent = '';
            }

            // Library card
            const libraryCount = data.library.count;
            document.getElementById('cardLibraryCount').textContent = libraryCount === 0
                ? 'Prazdna knihovna'
                : `${libraryCount} kav`;

            const cardLibraryBadge = document.getElementById('cardLibraryBadge');
            if (data.library.recent_count > 0) {
                cardLibraryBadge.textContent = `${data.library.recent_count} novych tento mesic`;
            } else {
                cardLibraryBadge.textContent = '';
            }

            // Beans card
            document.getElementById('cardBeansCount').textContent = `${data.beans.total_count} kav`;

            // Payments card
            const cardDebtBadge = document.getElementById('cardDebtBadge');
            if (data.payments.total_outstanding > 0) {
                cardDebtBadge.textContent = `Dluzis ${formatCZK(data.payments.total_outstanding)}`;
                cardDebtBadge.classList.add('alert');
            } else {
                cardDebtBadge.textContent = 'Vse zaplaceno';
                cardDebtBadge.classList.remove('alert');
            }

            // Render groups list
            renderGroups(data.groups.list);

            // Render payments
            renderPayments(data.payments);
        }

        // Render payments list
        function renderPayments(payments) {
            const paymentsSection = document.getElementById('paymentsSection');
            const paymentsList = document.getElementById('paymentsList');

            if (payments.count === 0) {
                paymentsSection.style.display = 'none';
                return;
            }

            paymentsSection.style.display = 'block';

            let html = '';
            payments.list.forEach(payment => {
                html += `
                    <div class="activity-item">
                        <div class="activity-icon">üí∞</div>
                        <div class="activity-content">
                            <p class="activity-text">Dluzis <strong>${formatCZK(payment.amount_czk)}</strong></p>
                            <p class="activity-time">${escapeHtml(payment.bean_name || 'Neznama kava')}${payment.group_name ? ' ‚Ä¢ ' + escapeHtml(payment.group_name) : ''}</p>
                        </div>
                        <div class="activity-action">
                            <button class="btn-small primary">Zaplatit</button>
                        </div>
                    </div>
                `;
            });

            paymentsList.innerHTML = html;
        }

        // Load dashboard data from API
        async function loadDashboard() {
            try {
                const data = await api.analytics.getDashboard();
                renderDashboard(data);
            } catch (error) {
                console.error('Failed to load dashboard:', error);
                // Show error state
                document.getElementById('statReviews').textContent = '0';
                document.getElementById('statLibrary').textContent = '0';
                document.getElementById('statGroups').textContent = '0';
                document.getElementById('cardGroupsCount').textContent = 'Chyba';
                document.getElementById('cardLibraryCount').textContent = 'Chyba';
                document.getElementById('cardBeansCount').textContent = '-';
                document.getElementById('cardDebtBadge').textContent = '-';

                // If 401, redirect to login
                if (error instanceof ApiError && error.status === 401) {
                    AuthStore.logout();
                    window.location.href = Config.ROUTES.LOGIN;
                }
            }
        }

        // Toggle user dropdown
        let dropdownOpen = false;

        function toggleDropdown() {
            dropdownOpen = !dropdownOpen;
            userDropdown.classList.toggle('open', dropdownOpen);
        }

        function closeDropdown() {
            dropdownOpen = false;
            userDropdown.classList.remove('open');
        }

        userAvatarEl.addEventListener('click', (e) => {
            e.stopPropagation();
            toggleDropdown();
        });

        userAvatarEl.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' || e.key === ' ') {
                e.preventDefault();
                toggleDropdown();
            }
        });

        document.addEventListener('click', (e) => {
            if (!userDropdown.contains(e.target) && !userAvatarEl.contains(e.target)) {
                closeDropdown();
            }
        });

        // Logout handler
        logoutBtn.addEventListener('click', async () => {
            try {
                await api.auth.logout();
            } catch (error) {
                console.error('Logout error:', error);
            } finally {
                AuthStore.logout();
                window.location.href = Config.ROUTES.LOGIN;
            }
        });

        // FAB toggle
        let fabOpen = false;

        function toggleFab() {
            fabOpen = !fabOpen;
            fabBtn.setAttribute('aria-expanded', fabOpen);

            if (fabOpen) {
                fabBtn.style.transform = 'rotate(45deg)';
                fabMenu.classList.add('open');
                fabOverlay.classList.add('open');
            } else {
                fabBtn.style.transform = 'rotate(0deg)';
                fabMenu.classList.remove('open');
                fabOverlay.classList.remove('open');
            }
        }

        fabBtn.addEventListener('click', toggleFab);
        fabOverlay.addEventListener('click', toggleFab);

        // FAB menu item handlers - fabAddPurchase now uses direct link

        // Render groups
        function renderGroups(groups) {
            const groupsList = document.getElementById('groupsList');
            let html = '';

            // Add button always first
            html += `
                <a href="${Config.ROUTES.GROUP_CREATE}" class="group-card group-card-add">
                    <div class="group-card-icon">+</div>
                    <div class="group-card-info">
                        <h4>Pridat skupinu</h4>
                        <p>Vytvorit nebo pripojit</p>
                    </div>
                </a>
            `;

            // Show max 3 groups (to fill 2x2 grid)
            groups.slice(0, 3).forEach(group => {
                const groupUrl = `/groups/${group.id}/`;
                html += `
                    <a href="${groupUrl}" class="group-card" data-group-id="${group.id}">
                        <div class="group-card-icon">${group.icon || 'üë•'}</div>
                        <div class="group-card-info">
                            <h4>${escapeHtml(group.name)}</h4>
                            <p>${group.member_count || 0} clenu</p>
                        </div>
                    </a>
                `;
            });

            groupsList.innerHTML = html;
        }

        // === ADD BEAN MODAL ===
        const addBeanModal = document.getElementById('addBeanModal');
        const addBeanForm = document.getElementById('addBeanForm');
        const beanSearchInput = document.getElementById('beanSearchInput');
        const beanSearchResults = document.getElementById('beanSearchResults');
        const selectedBeanId = document.getElementById('selectedBeanId');
        const selectedBeanDisplay = document.getElementById('selectedBeanDisplay');
        const selectedBeanName = document.getElementById('selectedBeanName');
        const selectedBeanMeta = document.getElementById('selectedBeanMeta');
        const removeBeanBtn = document.getElementById('removeBeanBtn');
        const cancelAddBeanBtn = document.getElementById('cancelAddBeanBtn');
        const submitAddBeanBtn = document.getElementById('submitAddBeanBtn');
        const addBeanError = document.getElementById('addBeanError');
        const fabAddBean = document.getElementById('fabAddBean');

        // Create new bean elements
        const searchBeanSection = document.getElementById('searchBeanSection');
        const createBeanSection = document.getElementById('createBeanSection');
        const showCreateBeanBtn = document.getElementById('showCreateBeanBtn');
        const backToSearchBtn = document.getElementById('backToSearchBtn');
        const newBeanName = document.getElementById('newBeanName');
        const newBeanRoastery = document.getElementById('newBeanRoastery');
        const newBeanOrigin = document.getElementById('newBeanOrigin');
        const newBeanRoast = document.getElementById('newBeanRoast');
        const newBeanProcessing = document.getElementById('newBeanProcessing');

        let beanSearchTimeout;
        let isCreateMode = false;

        // Open add bean modal from FAB
        fabAddBean.addEventListener('click', (e) => {
            e.preventDefault();
            toggleFab(); // Close FAB menu
            openAddBeanModal();
        });

        function openAddBeanModal() {
            addBeanModal.classList.add('visible');
            resetAddBeanModal();
            beanSearchInput.focus();
        }

        // Reset modal to initial state
        function resetAddBeanModal() {
            isCreateMode = false;
            searchBeanSection.style.display = 'block';
            createBeanSection.style.display = 'none';
            beanSearchInput.value = '';
            selectedBeanId.value = '';
            selectedBeanDisplay.style.display = 'none';
            beanSearchInput.style.display = 'block';
            beanSearchResults.classList.remove('visible');
            addBeanError.classList.remove('visible');
            submitAddBeanBtn.disabled = true;
            submitAddBeanBtn.querySelector('.btn-text').textContent = 'Pridat';
            // Reset create form fields
            newBeanName.value = '';
            newBeanRoastery.value = '';
            newBeanOrigin.value = '';
            newBeanRoast.value = 'medium';
            newBeanProcessing.value = 'washed';
        }

        // Close add bean modal
        function closeAddBeanModal() {
            addBeanModal.classList.remove('visible');
        }

        cancelAddBeanBtn.addEventListener('click', closeAddBeanModal);
        addBeanModal.addEventListener('click', (e) => {
            if (e.target === addBeanModal) closeAddBeanModal();
        });

        // Toggle to create mode
        showCreateBeanBtn.addEventListener('click', () => {
            isCreateMode = true;
            searchBeanSection.style.display = 'none';
            createBeanSection.style.display = 'block';
            submitAddBeanBtn.disabled = false;
            submitAddBeanBtn.querySelector('.btn-text').textContent = 'Vytvorit';
            newBeanName.focus();
        });

        // Toggle back to search mode
        backToSearchBtn.addEventListener('click', () => {
            isCreateMode = false;
            searchBeanSection.style.display = 'block';
            createBeanSection.style.display = 'none';
            submitAddBeanBtn.disabled = !selectedBeanId.value;
            submitAddBeanBtn.querySelector('.btn-text').textContent = 'Pridat';
            beanSearchInput.focus();
        });

        // Search beans
        beanSearchInput.addEventListener('input', (e) => {
            clearTimeout(beanSearchTimeout);
            const query = e.target.value.trim();

            if (query.length < 2) {
                beanSearchResults.classList.remove('visible');
                return;
            }

            beanSearchTimeout = setTimeout(async () => {
                try {
                    const response = await api.beans.list({ search: query });
                    const beans = response.results || response;

                    if (beans.length === 0) {
                        beanSearchResults.innerHTML = '<div class="search-no-results">Zadne vysledky - zkuste vytvorit novou kavu</div>';
                    } else {
                        beanSearchResults.innerHTML = beans.slice(0, 5).map(bean => `
                            <div class="search-result-item" data-id="${bean.id}" data-name="${escapeHtml(bean.name)}" data-roastery="${escapeHtml(bean.roastery_name || '')}">
                                <div class="search-result-name">${escapeHtml(bean.name)}</div>
                                <div class="search-result-meta">${escapeHtml(bean.roastery_name || 'Neznama prazirna')}</div>
                            </div>
                        `).join('');
                    }
                    beanSearchResults.classList.add('visible');
                } catch (error) {
                    console.error('Search error:', error);
                }
            }, 300);
        });

        // Select bean from search results
        beanSearchResults.addEventListener('click', (e) => {
            const item = e.target.closest('.search-result-item');
            if (item) {
                selectedBeanId.value = item.dataset.id;
                selectedBeanName.textContent = item.dataset.name;
                selectedBeanMeta.textContent = item.dataset.roastery || 'Neznama prazirna';
                selectedBeanDisplay.style.display = 'flex';
                beanSearchInput.style.display = 'none';
                beanSearchResults.classList.remove('visible');
                submitAddBeanBtn.disabled = false;
            }
        });

        // Remove selected bean
        removeBeanBtn.addEventListener('click', () => {
            selectedBeanId.value = '';
            selectedBeanDisplay.style.display = 'none';
            beanSearchInput.style.display = 'block';
            beanSearchInput.value = '';
            submitAddBeanBtn.disabled = true;
            beanSearchInput.focus();
        });

        // Submit add bean form
        addBeanForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            addBeanError.classList.remove('visible');

            submitAddBeanBtn.disabled = true;
            submitAddBeanBtn.classList.add('btn-loading');

            try {
                let beanId;

                if (isCreateMode) {
                    // Validate create form
                    const name = newBeanName.value.trim();
                    const roastery = newBeanRoastery.value.trim();

                    if (!name) {
                        throw { data: { error: 'Zadejte nazev kavy' } };
                    }
                    if (!roastery) {
                        throw { data: { error: 'Zadejte nazev prazirny' } };
                    }

                    // Create new bean
                    const newBean = await api.beans.create({
                        name: name,
                        roastery_name: roastery,
                        origin_country: newBeanOrigin.value.trim() || undefined,
                        roast_profile: newBeanRoast.value,
                        processing: newBeanProcessing.value
                    });
                    beanId = newBean.id;

                    // Navigate to the new bean's detail page
                    closeAddBeanModal();
                    window.location.href = `/beans/${beanId}/`;
                } else {
                    // Use selected existing bean - navigate to its detail page
                    beanId = selectedBeanId.value;
                    if (!beanId) {
                        throw { data: { error: 'Vyberte kavu' } };
                    }
                    closeAddBeanModal();
                    window.location.href = `/beans/${beanId}/`;
                }

            } catch (error) {
                console.error('Failed to add bean:', error);
                addBeanError.textContent = error.data?.error || error.data?.detail || error.data?.name?.[0] || 'Nepodarilo se pridat kavu';
                addBeanError.classList.add('visible');
                submitAddBeanBtn.disabled = false;
            } finally {
                submitAddBeanBtn.classList.remove('btn-loading');
            }
        });

        // === ADD REVIEW MODAL (Bean Picker) ===
        const addReviewModal = document.getElementById('addReviewModal');
        const reviewBeanSearchInput = document.getElementById('reviewBeanSearchInput');
        const reviewBeanSearchResults = document.getElementById('reviewBeanSearchResults');
        const reviewSelectedBeanId = document.getElementById('reviewSelectedBeanId');
        const reviewSelectedBeanDisplay = document.getElementById('reviewSelectedBeanDisplay');
        const reviewSelectedBeanName = document.getElementById('reviewSelectedBeanName');
        const reviewSelectedBeanMeta = document.getElementById('reviewSelectedBeanMeta');
        const reviewRemoveBeanBtn = document.getElementById('reviewRemoveBeanBtn');
        const cancelAddReviewBtn = document.getElementById('cancelAddReviewBtn');
        const continueToReviewBtn = document.getElementById('continueToReviewBtn');
        const addReviewError = document.getElementById('addReviewError');
        const fabAddReview = document.getElementById('fabAddReview');

        // Create bean section elements
        const reviewSearchBeanSection = document.getElementById('reviewSearchBeanSection');
        const reviewCreateBeanSection = document.getElementById('reviewCreateBeanSection');
        const reviewShowCreateBeanBtn = document.getElementById('reviewShowCreateBeanBtn');
        const reviewBackToSearchBtn = document.getElementById('reviewBackToSearchBtn');
        const reviewNewBeanName = document.getElementById('reviewNewBeanName');
        const reviewNewBeanRoastery = document.getElementById('reviewNewBeanRoastery');
        const reviewNewBeanOrigin = document.getElementById('reviewNewBeanOrigin');

        let reviewBeanSearchTimeout;
        let reviewIsCreateMode = false;

        // Open review modal from FAB
        fabAddReview.addEventListener('click', (e) => {
            e.preventDefault();
            toggleFab();
            openAddReviewModal();
        });

        function openAddReviewModal() {
            addReviewModal.classList.add('visible');
            resetAddReviewModal();
            reviewBeanSearchInput.focus();
        }

        // Reset review modal to initial state
        function resetAddReviewModal() {
            reviewIsCreateMode = false;
            reviewSearchBeanSection.style.display = 'block';
            reviewCreateBeanSection.style.display = 'none';
            reviewBeanSearchInput.value = '';
            reviewSelectedBeanId.value = '';
            reviewSelectedBeanDisplay.style.display = 'none';
            reviewBeanSearchInput.style.display = 'block';
            reviewBeanSearchResults.classList.remove('visible');
            addReviewError.classList.remove('visible');
            continueToReviewBtn.disabled = true;
            continueToReviewBtn.querySelector('.btn-text').textContent = 'Pokracovat';
            // Reset create form
            reviewNewBeanName.value = '';
            reviewNewBeanRoastery.value = '';
            reviewNewBeanOrigin.value = '';
        }

        // Close review modal
        function closeAddReviewModal() {
            addReviewModal.classList.remove('visible');
        }

        cancelAddReviewBtn.addEventListener('click', closeAddReviewModal);
        addReviewModal.addEventListener('click', (e) => {
            if (e.target === addReviewModal) closeAddReviewModal();
        });

        // Toggle to create mode
        reviewShowCreateBeanBtn.addEventListener('click', () => {
            reviewIsCreateMode = true;
            reviewSearchBeanSection.style.display = 'none';
            reviewCreateBeanSection.style.display = 'block';
            continueToReviewBtn.disabled = false;
            continueToReviewBtn.querySelector('.btn-text').textContent = 'Vytvorit a pokracovat';
            reviewNewBeanName.focus();
        });

        // Toggle back to search mode
        reviewBackToSearchBtn.addEventListener('click', () => {
            reviewIsCreateMode = false;
            reviewSearchBeanSection.style.display = 'block';
            reviewCreateBeanSection.style.display = 'none';
            continueToReviewBtn.disabled = !reviewSelectedBeanId.value;
            continueToReviewBtn.querySelector('.btn-text').textContent = 'Pokracovat';
            reviewBeanSearchInput.focus();
        });

        // Search beans for review
        reviewBeanSearchInput.addEventListener('input', (e) => {
            clearTimeout(reviewBeanSearchTimeout);
            const query = e.target.value.trim();

            if (query.length < 2) {
                reviewBeanSearchResults.classList.remove('visible');
                return;
            }

            reviewBeanSearchTimeout = setTimeout(async () => {
                try {
                    const response = await api.beans.list({ search: query });
                    const beans = response.results || response;

                    if (beans.length === 0) {
                        reviewBeanSearchResults.innerHTML = '<div class="search-no-results">Zadne vysledky - zkuste pridat novou kavu</div>';
                    } else {
                        reviewBeanSearchResults.innerHTML = beans.slice(0, 5).map(bean => `
                            <div class="search-result-item" data-id="${bean.id}" data-name="${escapeHtml(bean.name)}" data-roastery="${escapeHtml(bean.roastery_name || '')}">
                                <div class="search-result-name">${escapeHtml(bean.name)}</div>
                                <div class="search-result-meta">${escapeHtml(bean.roastery_name || 'Neznama prazirna')}</div>
                            </div>
                        `).join('');
                    }
                    reviewBeanSearchResults.classList.add('visible');
                } catch (error) {
                    console.error('Search error:', error);
                }
            }, 300);
        });

        // Select bean from search results
        reviewBeanSearchResults.addEventListener('click', (e) => {
            const item = e.target.closest('.search-result-item');
            if (item) {
                reviewSelectedBeanId.value = item.dataset.id;
                reviewSelectedBeanName.textContent = item.dataset.name;
                reviewSelectedBeanMeta.textContent = item.dataset.roastery || 'Neznama prazirna';
                reviewSelectedBeanDisplay.style.display = 'flex';
                reviewBeanSearchInput.style.display = 'none';
                reviewBeanSearchResults.classList.remove('visible');
                continueToReviewBtn.disabled = false;
            }
        });

        // Remove selected bean
        reviewRemoveBeanBtn.addEventListener('click', () => {
            reviewSelectedBeanId.value = '';
            reviewSelectedBeanDisplay.style.display = 'none';
            reviewBeanSearchInput.style.display = 'block';
            reviewBeanSearchInput.value = '';
            continueToReviewBtn.disabled = true;
            reviewBeanSearchInput.focus();
        });

        // Continue to review form
        continueToReviewBtn.addEventListener('click', async () => {
            addReviewError.classList.remove('visible');

            continueToReviewBtn.disabled = true;
            continueToReviewBtn.classList.add('btn-loading');

            try {
                let beanId;

                if (reviewIsCreateMode) {
                    // Validate and create new bean
                    const name = reviewNewBeanName.value.trim();
                    const roastery = reviewNewBeanRoastery.value.trim();

                    if (!name) {
                        throw { data: { error: 'Zadejte nazev kavy' } };
                    }
                    if (!roastery) {
                        throw { data: { error: 'Zadejte nazev prazirny' } };
                    }

                    const newBean = await api.beans.create({
                        name: name,
                        roastery_name: roastery,
                        origin_country: reviewNewBeanOrigin.value.trim() || undefined
                    });
                    beanId = newBean.id;
                } else {
                    beanId = reviewSelectedBeanId.value;
                    if (!beanId) {
                        throw { data: { error: 'Vyberte kavu' } };
                    }
                }

                // Redirect to full review form
                closeAddReviewModal();
                window.location.href = `/reviews/create/?bean=${beanId}`;

            } catch (error) {
                console.error('Error:', error);
                addReviewError.textContent = error.data?.error || error.data?.detail || 'Nastala chyba';
                addReviewError.classList.add('visible');
                continueToReviewBtn.disabled = false;
            } finally {
                continueToReviewBtn.classList.remove('btn-loading');
            }
        });

        // Update Escape handler to also close modals
        document.removeEventListener('keydown', document.escapeHandler);
        document.escapeHandler = (e) => {
            if (e.key === 'Escape') {
                if (addReviewModal.classList.contains('visible')) {
                    closeAddReviewModal();
                } else if (addBeanModal.classList.contains('visible')) {
                    closeAddBeanModal();
                } else if (fabOpen) {
                    toggleFab();
                }
                if (dropdownOpen) closeDropdown();
            }
        };
        document.addEventListener('keydown', document.escapeHandler);

        // Initialize
        updateGreeting();
        loadUserData();
        loadDashboard();
    </script>
</body>
</html>
