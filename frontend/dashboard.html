<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#2C1810">
    <title>Kavarna - Dashboard</title>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;500;600&family=DM+Sans:wght@400;500;600&display=swap" rel="stylesheet">

    <!-- Stylesheets -->
    <link rel="stylesheet" href="/static/css/variables.css">
    <link rel="stylesheet" href="/static/css/base.css">
    <link rel="stylesheet" href="/static/css/components.css">
    <link rel="stylesheet" href="/static/css/animations.css">
    <link rel="stylesheet" href="/static/css/dashboard.css">

    <style>
        /* Loading skeleton */
        .skeleton {
            background: linear-gradient(90deg, var(--latte) 25%, var(--milk-foam) 50%, var(--latte) 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
            border-radius: var(--radius-md);
        }

        @keyframes shimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        .skeleton-text {
            height: 1em;
            width: 100px;
            display: inline-block;
        }

        .skeleton-text.short { width: 60px; }
        .skeleton-text.long { width: 150px; }

        /* User menu dropdown */
        .user-menu { position: relative; }

        .user-dropdown {
            position: absolute;
            top: calc(100% + 8px);
            right: 0;
            background: var(--porcelain);
            border: 1px solid var(--latte);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
            min-width: 200px;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all var(--transition-base);
            z-index: var(--z-dropdown);
        }

        .user-dropdown.open {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .user-dropdown-header {
            padding: 16px;
            border-bottom: 1px solid var(--latte);
        }

        .user-dropdown-name {
            font-weight: 500;
            color: var(--espresso);
        }

        .user-dropdown-email {
            font-size: var(--text-sm);
            color: var(--steam);
            margin-top: 2px;
        }

        .user-dropdown-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            color: var(--espresso);
            text-decoration: none;
            transition: background var(--transition-base);
            cursor: pointer;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
            font-size: var(--text-base);
        }

        .user-dropdown-item:hover { background: var(--milk-foam); }
        .user-dropdown-item.danger { color: var(--error); }
        .user-dropdown-item svg { width: 18px; height: 18px; color: var(--steam); }
        .user-dropdown-item.danger svg { color: var(--error); }
        .user-dropdown-divider { height: 1px; background: var(--latte); margin: 4px 0; }

        /* Empty state */
        .empty-state {
            text-align: center;
            padding: 24px 16px;
            color: var(--steam);
        }

        /* Groups Grid */
        .groups-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }

        .group-card {
            display: flex;
            flex-direction: column;
            gap: 10px;
            padding: 16px;
            background: var(--porcelain);
            border: 1px solid var(--latte);
            border-radius: var(--radius-xl);
            cursor: pointer;
            transition: all var(--transition-base);
            text-decoration: none;
            color: inherit;
        }

        .group-card:hover {
            border-color: var(--crema-light);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .group-card-icon {
            width: 44px;
            height: 44px;
            background: linear-gradient(135deg, var(--espresso), var(--espresso-light));
            border-radius: var(--radius-lg);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
        }

        .group-card-info h4 {
            font-family: var(--font-display);
            font-size: 1rem;
            font-weight: 500;
            margin-bottom: 2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .group-card-info p {
            font-size: 0.75rem;
            color: var(--steam);
        }

        /* Add group card */
        .group-card-add {
            border-style: dashed;
            border-color: var(--caramel);
            background: linear-gradient(135deg, rgba(164, 116, 73, 0.05), rgba(164, 116, 73, 0.02));
        }

        .group-card-add:hover {
            border-color: var(--caramel);
            background: linear-gradient(135deg, rgba(164, 116, 73, 0.1), rgba(164, 116, 73, 0.05));
        }

        .group-card-add .group-card-icon {
            background: var(--caramel);
            color: var(--porcelain);
            font-size: 1.5rem;
            font-weight: 300;
        }

        .group-card-add .group-card-info h4 {
            color: var(--caramel);
        }

        .group-card-skeleton {
            height: 100px;
            border-radius: var(--radius-xl);
        }
    </style>
</head>
<body class="dashboard">
    <div class="app">
        <!-- Header -->
        <header class="header">
            <div class="header-top">
                <div class="greeting">
                    <p class="greeting-text" id="greetingText">Dobry den</p>
                    <h1 class="greeting-name" id="userName">
                        <span class="skeleton skeleton-text long"></span>
                    </h1>
                </div>
                <div class="header-actions">
                    <div class="user-menu">
                        <div class="avatar" role="button" aria-label="Uzivatelske menu" id="userAvatar" tabindex="0">?</div>
                        <div class="user-dropdown" id="userDropdown">
                            <div class="user-dropdown-header">
                                <div class="user-dropdown-name" id="dropdownName">-</div>
                                <div class="user-dropdown-email" id="dropdownEmail">-</div>
                            </div>
                            <a href="#" class="user-dropdown-item">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                    <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                                    <circle cx="12" cy="7" r="4"/>
                                </svg>
                                Muj profil
                            </a>
                            <a href="#" class="user-dropdown-item">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                    <circle cx="12" cy="12" r="3"/>
                                    <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/>
                                </svg>
                                Nastaveni
                            </a>
                            <div class="user-dropdown-divider"></div>
                            <button class="user-dropdown-item danger" id="logoutBtn">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                    <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
                                    <polyline points="16 17 21 12 16 7"/>
                                    <line x1="21" y1="12" x2="9" y2="12"/>
                                </svg>
                                Odhlasit se
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Quick Stats -->
        <div class="quick-stats">
            <div class="quick-stat">
                <div class="quick-stat-value" id="statReviews">-</div>
                <div class="quick-stat-label">Hodnoceni</div>
            </div>
            <div class="quick-stat">
                <div class="quick-stat-value" id="statLibrary">-</div>
                <div class="quick-stat-label">V knihovne</div>
            </div>
            <div class="quick-stat">
                <div class="quick-stat-value" id="statGroups">-</div>
                <div class="quick-stat-label">Skupiny</div>
            </div>
        </div>

        <!-- Main Navigation Cards -->
        <section class="section">
            <div class="nav-cards">
                <a href="#" class="nav-card animate-fade-in-up delay-1">
                    <div class="nav-card-icon groups">üë•</div>
                    <div class="nav-card-content">
                        <h3>Skupiny</h3>
                        <p id="cardGroupsCount">Nacitam...</p>
                        <span class="nav-card-badge" id="cardGroupsMembers"></span>
                    </div>
                </a>

                <a href="#" class="nav-card animate-fade-in-up delay-2">
                    <div class="nav-card-icon library">üìö</div>
                    <div class="nav-card-content">
                        <h3>Moje knihovna</h3>
                        <p id="cardLibraryCount">Nacitam...</p>
                        <span class="nav-card-badge" id="cardLibraryBadge"></span>
                    </div>
                </a>

                <a href="#" class="nav-card animate-fade-in-up delay-3">
                    <div class="nav-card-icon discover">üîç</div>
                    <div class="nav-card-content">
                        <h3>Objevovat</h3>
                        <p>Katalog kav</p>
                        <span class="nav-card-badge" id="cardBeansCount">-</span>
                    </div>
                </a>

                <a href="#" class="nav-card animate-fade-in-up delay-4">
                    <div class="nav-card-icon purchases">üí∞</div>
                    <div class="nav-card-content">
                        <h3>Nakupy</h3>
                        <p>Platby & dluhy</p>
                        <span class="nav-card-badge" id="cardDebtBadge">-</span>
                    </div>
                </a>
            </div>
        </section>

        <!-- My Groups -->
        <section class="section">
            <div class="section-header">
                <h2 class="section-title">Moje skupiny</h2>
                <a href="#" class="section-link" id="showAllGroups">
                    Vsechny
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M9 18l6-6-6-6"/>
                    </svg>
                </a>
            </div>
            <div class="groups-grid" id="groupsList">
                <div class="skeleton group-card-skeleton"></div>
                <div class="skeleton group-card-skeleton"></div>
                <div class="skeleton group-card-skeleton"></div>
                <div class="skeleton group-card-skeleton"></div>
            </div>
        </section>

        <!-- Outstanding Payments -->
        <section class="section" id="paymentsSection" style="display: none;">
            <div class="section-header">
                <h2 class="section-title">Nezaplacene platby</h2>
            </div>
            <div id="paymentsList"></div>
        </section>
    </div>

    <!-- FAB Overlay -->
    <div class="fab-overlay" id="fabOverlay"></div>

    <!-- FAB Menu -->
    <div class="fab-menu" id="fabMenu">
        <a href="#" class="fab-menu-item"><span>‚òï</span><span>Pridat kavu</span></a>
        <a href="${Config.ROUTES.REVIEW_CREATE}" class="fab-menu-item"><span>‚≠ê</span><span>Nove hodnoceni</span></a>
        <a href="#" class="fab-menu-item"><span>üõí</span><span>Zaznamenat nakup</span></a>
    </div>

    <!-- Bottom Navigation -->
    <nav class="bottom-nav" aria-label="Hlavni navigace">
        <div class="nav-items">
            <a class="nav-item active" href="#" aria-current="page">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
                    <path d="M9 22V12h6v10"/>
                </svg>
                <span>Domu</span>
            </a>
            <a class="nav-item" href="#">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <circle cx="11" cy="11" r="8"/>
                    <path d="m21 21-4.35-4.35"/>
                </svg>
                <span>Hledat</span>
            </a>

            <button class="fab" id="fabBtn" aria-label="Rychle akce" aria-expanded="false">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 5v14M5 12h14"/>
                </svg>
            </button>

            <a class="nav-item" href="#">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                    <circle cx="9" cy="7" r="4"/>
                    <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
                    <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                </svg>
                <span>Skupiny</span>
            </a>
            <a class="nav-item" href="#">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                    <circle cx="12" cy="7" r="4"/>
                </svg>
                <span>Profil</span>
            </a>
        </div>
    </nav>

    <!-- Scripts -->
    <script type="module">
        import { api, ApiError } from '/static/js/api.js';
        import AuthStore from '/static/js/auth.js';
        import Config from '/static/js/config.js';

        // Check authentication
        if (!AuthStore.isAuthenticated()) {
            window.location.href = Config.ROUTES.LOGIN;
        }

        // DOM Elements
        const userNameEl = document.getElementById('userName');
        const userAvatarEl = document.getElementById('userAvatar');
        const userDropdown = document.getElementById('userDropdown');
        const dropdownNameEl = document.getElementById('dropdownName');
        const dropdownEmailEl = document.getElementById('dropdownEmail');
        const greetingTextEl = document.getElementById('greetingText');
        const logoutBtn = document.getElementById('logoutBtn');
        const fabBtn = document.getElementById('fabBtn');
        const fabMenu = document.getElementById('fabMenu');
        const fabOverlay = document.getElementById('fabOverlay');

        // Update greeting based on time
        function updateGreeting() {
            const hour = new Date().getHours();
            if (hour < 12) {
                greetingTextEl.textContent = 'Dobre rano';
            } else if (hour < 18) {
                greetingTextEl.textContent = 'Dobre odpoledne';
            } else {
                greetingTextEl.textContent = 'Dobry vecer';
            }
        }

        // Load user data from storage
        function loadUserData() {
            const user = AuthStore.getUser();
            const displayName = AuthStore.getDisplayName();
            const initials = AuthStore.getUserInitials();

            userNameEl.textContent = displayName;
            userAvatarEl.textContent = initials;

            if (user) {
                dropdownNameEl.textContent = user.display_name || displayName;
                dropdownEmailEl.textContent = user.email || '';
            }
        }

        // Escape HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text || '';
            return div.innerHTML;
        }

        // Format currency
        function formatCZK(amount) {
            return new Intl.NumberFormat('cs-CZ', {
                style: 'currency',
                currency: 'CZK',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(amount);
        }

        // Render dashboard data (all from single API call)
        function renderDashboard(data) {
            // Quick stats
            document.getElementById('statReviews').textContent = data.stats.reviews_count;
            document.getElementById('statLibrary').textContent = data.stats.library_count;
            document.getElementById('statGroups').textContent = data.stats.groups_count;

            // Groups card
            const groupsCount = data.stats.groups_count;
            document.getElementById('cardGroupsCount').textContent = groupsCount === 0
                ? 'Zadne skupiny'
                : `${groupsCount} ${groupsCount === 1 ? 'skupina' : groupsCount < 5 ? 'skupiny' : 'skupin'}`;

            const cardGroupsMembers = document.getElementById('cardGroupsMembers');
            if (data.groups.total_members > 0) {
                cardGroupsMembers.textContent = `${data.groups.total_members} clenu celkem`;
            } else {
                cardGroupsMembers.textContent = '';
            }

            // Library card
            const libraryCount = data.library.count;
            document.getElementById('cardLibraryCount').textContent = libraryCount === 0
                ? 'Prazdna knihovna'
                : `${libraryCount} kav`;

            const cardLibraryBadge = document.getElementById('cardLibraryBadge');
            if (data.library.recent_count > 0) {
                cardLibraryBadge.textContent = `${data.library.recent_count} novych tento mesic`;
            } else {
                cardLibraryBadge.textContent = '';
            }

            // Beans card
            document.getElementById('cardBeansCount').textContent = `${data.beans.total_count} kav`;

            // Payments card
            const cardDebtBadge = document.getElementById('cardDebtBadge');
            if (data.payments.total_outstanding > 0) {
                cardDebtBadge.textContent = `Dluzis ${formatCZK(data.payments.total_outstanding)}`;
                cardDebtBadge.classList.add('alert');
            } else {
                cardDebtBadge.textContent = 'Vse zaplaceno';
                cardDebtBadge.classList.remove('alert');
            }

            // Render groups list
            renderGroups(data.groups.list);

            // Render payments
            renderPayments(data.payments);
        }

        // Render groups grid (2x2: add button + max 3 groups)
        function renderGroups(groups) {
            const groupsList = document.getElementById('groupsList');
            let html = '';

            // Add button always first
            html += `
                <a href="${Config.ROUTES.GROUP_CREATE}" class="group-card group-card-add">
                    <div class="group-card-icon">+</div>
                    <div class="group-card-info">
                        <h4>Pridat skupinu</h4>
                        <p>Vytvorit nebo pripojit</p>
                    </div>
                </a>
            `;

            // Show max 3 groups (to fill 2x2 grid)
            groups.slice(0, 3).forEach(group => {
                html += `
                    <a href="#" class="group-card" data-group-id="${group.id}">
                        <div class="group-card-icon">${group.icon || 'üë•'}</div>
                        <div class="group-card-info">
                            <h4>${escapeHtml(group.name)}</h4>
                            <p>${group.member_count || 0} clenu</p>
                        </div>
                    </a>
                `;
            });

            groupsList.innerHTML = html;
        }

        // Render payments list
        function renderPayments(payments) {
            const paymentsSection = document.getElementById('paymentsSection');
            const paymentsList = document.getElementById('paymentsList');

            if (payments.count === 0) {
                paymentsSection.style.display = 'none';
                return;
            }

            paymentsSection.style.display = 'block';

            let html = '';
            payments.list.forEach(payment => {
                html += `
                    <div class="activity-item">
                        <div class="activity-icon">üí∞</div>
                        <div class="activity-content">
                            <p class="activity-text">Dluzis <strong>${formatCZK(payment.amount_czk)}</strong></p>
                            <p class="activity-time">${escapeHtml(payment.bean_name || 'Neznama kava')}${payment.group_name ? ' ‚Ä¢ ' + escapeHtml(payment.group_name) : ''}</p>
                        </div>
                        <div class="activity-action">
                            <button class="btn-small primary">Zaplatit</button>
                        </div>
                    </div>
                `;
            });

            paymentsList.innerHTML = html;
        }

        // Load dashboard data from API
        async function loadDashboard() {
            try {
                const data = await api.analytics.getDashboard();
                renderDashboard(data);
            } catch (error) {
                console.error('Failed to load dashboard:', error);
                // Show error state
                document.getElementById('statReviews').textContent = '0';
                document.getElementById('statLibrary').textContent = '0';
                document.getElementById('statGroups').textContent = '0';
                document.getElementById('cardGroupsCount').textContent = 'Chyba';
                document.getElementById('cardLibraryCount').textContent = 'Chyba';
                document.getElementById('cardBeansCount').textContent = '-';
                document.getElementById('cardDebtBadge').textContent = '-';

                // If 401, redirect to login
                if (error instanceof ApiError && error.status === 401) {
                    AuthStore.logout();
                    window.location.href = Config.ROUTES.LOGIN;
                }
            }
        }

        // Toggle user dropdown
        let dropdownOpen = false;

        function toggleDropdown() {
            dropdownOpen = !dropdownOpen;
            userDropdown.classList.toggle('open', dropdownOpen);
        }

        function closeDropdown() {
            dropdownOpen = false;
            userDropdown.classList.remove('open');
        }

        userAvatarEl.addEventListener('click', (e) => {
            e.stopPropagation();
            toggleDropdown();
        });

        userAvatarEl.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' || e.key === ' ') {
                e.preventDefault();
                toggleDropdown();
            }
        });

        document.addEventListener('click', (e) => {
            if (!userDropdown.contains(e.target) && !userAvatarEl.contains(e.target)) {
                closeDropdown();
            }
        });

        // Logout handler
        logoutBtn.addEventListener('click', async () => {
            try {
                await api.auth.logout();
            } catch (error) {
                console.error('Logout error:', error);
            } finally {
                AuthStore.logout();
                window.location.href = Config.ROUTES.LOGIN;
            }
        });

        // FAB toggle
        let fabOpen = false;

        function toggleFab() {
            fabOpen = !fabOpen;
            fabBtn.setAttribute('aria-expanded', fabOpen);

            if (fabOpen) {
                fabBtn.style.transform = 'rotate(45deg)';
                fabMenu.classList.add('open');
                fabOverlay.classList.add('open');
            } else {
                fabBtn.style.transform = 'rotate(0deg)';
                fabMenu.classList.remove('open');
                fabOverlay.classList.remove('open');
            }
        }

        fabBtn.addEventListener('click', toggleFab);
        fabOverlay.addEventListener('click', toggleFab);

        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                if (fabOpen) toggleFab();
                if (dropdownOpen) closeDropdown();
            }
        });

        // Initialize
        updateGreeting();
        loadUserData();
        loadDashboard();
    </script>
</body>
</html>
